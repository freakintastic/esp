<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ESP Solutions - Integrated App</title>
  
  <!-- Google Fonts for ESP Solutions -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link 
    href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" 
    rel="stylesheet"
  />
  
  <!-- External Libraries for Trend App -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <!-- ESP Solutions CSS -->
  <style>
    /* Global resets & Baker Hughesâ€“inspired styling */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Open Sans', sans-serif; background: #FFFFFF; color: #333; }
    header, footer {
      background: #009193;
      color: #fff;
      text-align: center;
      padding: 1rem;
    }
    header h1, footer p { font-weight: 600; }
    .container {
      max-width: 800px;
      margin: 2rem auto;
      background: #fff;
      padding: 2rem;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    .container-table {
      max-width: 600px;
      margin: 2rem auto;
      background: #fff;
      padding: 1rem;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    h1, h2, h3 { margin-bottom: 1rem; font-weight: 600; color: #333; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
    th, td { padding: 0.75rem; border: 1px solid #ddd; text-align: left; }
    .btn, .nav-btn {
      background: #009193;
      color: #fff;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 4px;
      cursor: pointer;
      margin: 0.5rem 0;
      font-size: 1rem;
      transition: background 0.2s ease;
    }
    .btn:hover, .nav-btn:hover { background: #007A7A; }
    .calc-section { margin-top: 2rem; }
    .results {
      background: #f7f9f9;
      padding: 1rem;
      border-radius: 4px;
      margin-top: 1rem;
      border: 1px solid #e2e8e8;
    }
    .input-group { margin-bottom: 1rem; }
    label { display: block; margin-bottom: 0.25rem; font-weight: 600; color: #555; }
    input[type="number"], select, input[type="text"] {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .well-entry {
      margin: 0.5rem 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .well-entry input[type="text"] {
      flex: 1;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .content { display: none; }
    .content.active { display: block; }
    
    /* Trend Analysis Page Styles */
    #trendPage {
      background-color: #1a1a2f; 
      color: #ffffff;
      min-height: 100vh;
      padding: 2rem;
    }
    #trendPage * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    #trendPage .container {
      max-width: 1400px;
      margin: 0 auto;
      background: #2d2d44;
      border-radius: 15px;
      padding: 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    #trendPage .header {
      text-align: center;
      margin-bottom: 2rem;
    }
    #trendPage .header h1 {
      color: #4bc0c0;
      font-size: 2.5rem;
      margin-bottom: 1rem;
      text-shadow: 0 2px 4px rgba(75, 192, 192, 0.3);
    }
    #trendPage .upload-section {
      background: #3a3a5a;
      padding: 1.5rem;
      border-radius: 10px;
      margin-bottom: 2rem;
      border: 2px dashed #4bc0c0;
      transition: all 0.3s ease;
    }
    #trendPage .upload-section:hover {
      border-color: #ff9f40;
      background: #4a4a6a;
    }
    /* Flex container for file input, data type dropdown, transformer ratio input, and refresh button */
    #trendPage .file-select-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    #trendPage #fileInput, 
    #trendPage #dataTypeSelect,
    #trendPage #transformerRatioInput {
      font-size: 1rem;
      padding: 0.5rem;
    }
    #trendPage #transformerRatioInput,
    #trendPage #trRefreshButton {
      display: none;
      width: 150px;
    }
    #trendPage #excelData {
      width: 100%;
      height: 150px;
      padding: 1rem;
      background: #2a2a3a;
      border: 1px solid #4bc0c0;
      border-radius: 8px;
      color: #ffffff;
      margin: 1rem 0;
      resize: vertical;
    }
    #trendPage .controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin: 2rem 0;
    }
    #trendPage .slider-container {
      background: #3a3a5a;
      padding: 1.5rem;
      border-radius: 10px;
    }
    #trendPage .slider-group {
      margin: 1rem 0;
    }
    #trendPage .slider-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: #ff9f40;
    }
    #trendPage input[type="range"] {
      width: 100%;
      height: 5px;
      background: #2a2a3a;
      border-radius: 5px;
      outline: none;
      -webkit-appearance: none;
    }
    @media (min-width: 1024px) {
      #trendPage input[type="range"] {
        width: 600px;
      }
    }
    #trendPage #checkboxContainer {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      background: #3a3a5a;
      padding: 1.5rem;
      border-radius: 10px;
    }
    #trendPage #checkboxContainer label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #ffffff;
      cursor: pointer;
      padding: 8px;
      border-radius: 5px;
      transition: background 0.3s ease;
    }
    #trendPage #checkboxContainer label:hover {
      background: rgba(255, 159, 64, 0.1);
    }
    #trendPage input[type="checkbox"] {
      accent-color: #4bc0c0;
      width: 18px;
      height: 18px;
    }
    #trendPage .chart-container {
      background: #ffffff;
      padding: 1.5rem;
      border-radius: 10px;
      margin: 2rem 0;
      position: relative;
    }
    #trendPage #loadingSpinner {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #4bc0c0;
      font-size: 1.5rem;
    }
    #trendPage .export-buttons {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
      justify-content: flex-end;
      flex-wrap: wrap;
    }
    #trendPage button {
      background: linear-gradient(135deg, #4bc0c0 0%, #36a2eb 100%);
      color: white;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: bold;
      letter-spacing: 0.5px;
    }
    #trendPage button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(75, 192, 192, 0.4);
      background: linear-gradient(135deg, #ff9f40 0%, #ff6384 100%);
    }
    @media (max-width: 600px) {
      #trendPage .file-select-container {
        flex-direction: column;
        align-items: stretch;
      }
      #trendPage #fileInput, 
      #trendPage #dataTypeSelect,
      #trendPage #transformerRatioInput,
      #trendPage #trRefreshButton {
        width: 100%;
        font-size: 1.2em;
        padding: 10px;
      }
      #trendPage button {
        width: 100%;
        margin-top: 10px;
      }
    }
    /* Excelâ€‘Like Callout Styles */
    #trendPage .callout {
      position: absolute;
      border: 1px solid #666;
      background: #ffffff;
      color: #000;
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      overflow: visible;
      z-index: 20;
      padding: 5px;
      background-color: #ffffff;
    }
    #trendPage .callout-delete {
      position: absolute;
      top: 2px;
      right: 2px;
      background: transparent;
      border: none;
      color: #666;
      font-size: 14px;
      cursor: pointer;
      display: none;
    }
    #trendPage .callout:hover .callout-delete {
      display: block;
    }
    #trendPage .callout-content {
      padding: 2px;
      min-width: 100px;
      min-height: 30px;
      outline: none;
      font-size: 12px;
      background-color: #ffffff;
    }
    #trendPage .callout-resize-handle {
      width: 10px;
      height: 10px;
      background: #666;
      position: absolute;
      bottom: 0;
      right: 0;
      cursor: se-resize;
    }
    #trendPage .callout-drag-handle {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 10px;
      cursor: move;
    }
    #trendPage .tail-svg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
    }
    
    /* PGORT Well Listing & Input Page Styles */
    .well-entry { margin-bottom: 1rem; }
    
    /* PGORT Input Page Template */
    #pgortInputPageTemplate {
      display: none;
    }
    .pgortInputPage .container { max-width: 600px; }
    .pgortInputPage table { margin-bottom: 1rem; }
    .pgortInputPage h2 { margin-bottom: 1rem; }
  </style>
</head>
<body>
  <header>
    <h1>ESP Solutions</h1>
  </header>
  
  <!-- Main App Pages -->
  <div id="mainPage" class="content active">
    <div class="container">
      <div class="buttons">
        <button class="btn large-btn" onclick="showPage('commissioningPage')">Commissioning</button>
        <button class="btn large-btn" onclick="showPage('pgortPage')">PGORT</button>
        <button class="btn large-btn" onclick="showPage('trendPage')">Trend Analysis</button>
      </div>
    </div>
  </div>
  
  <!-- Commissioning Page -->
  <div id="commissioningPage" class="content">
    <div class="container">
      <div class="buttons">
        <button class="btn large-btn" onclick="showPage('installationParametersPage')">
          Installation Parameters & Surface Voltage Calculation
        </button>
        <button class="btn large-btn" onclick="showPage('setPointsPage')">SetPoints</button>
      </div>
      <div class="navigation-buttons">
        <button class="nav-btn" onclick="showPage('mainPage')">Main Menu</button>
      </div>
    </div>
  </div>
  
  <!-- Installation Parameters Page -->
  <div id="installationParametersPage" class="content">
    <div class="container">
      <h2>Installation Parameters & Surface Voltage Calculation</h2>
      <table>
        <tr><th colspan="2">VSD</th></tr>
        <tr>
          <td>Manufacturer</td>
          <td>
            <select id="manufacturer-installation">
              <option value="Baker Hughes">Baker Hughes</option>
              <option value="SLB">SLB</option>
              <option value="Alkhorayef">Alkhorayef</option>
            </select>
          </td>
        </tr>
        <tr><th colspan="2">Motor @50 HZ</th></tr>
        <tr><td>Desired Frequency</td><td><input type="number" id="desiredFrequency" value=""></td></tr>
        <tr><td>HP</td><td><input type="number" id="hp" value=""></td></tr>
        <tr><td>Voltage</td><td><input type="number" id="voltage" value=""></td></tr>
        <tr><td>Amps</td><td><input type="number" id="amps" value=""></td></tr>
        <tr><th colspan="2">Cable</th></tr>
        <tr><td>Length (ft)</td><td><input type="number" id="cableLength" value=""></td></tr>
        <tr><td>Size</td><td><input type="number" id="cableSize" value=""></td></tr>
        <tr><th colspan="2">Well</th></tr>
        <tr><td>BHT (FÂ°)</td><td><input type="number" id="bht" value=""></td></tr>
      </table>
      
      <div class="calc-section">
        <button class="btn" onclick="calculateVoltageInline()">Calculate Surface Voltage</button>
        <div class="results" id="voltageResults">
          <p>Voltage @ 50 HZ: <span id="voltage50Hz">--</span></p>
          <p>Voltage @ <span id="desiredFrequencyLabel">60</span> HZ: <span id="voltageDesiredHz">--</span></p>
        </div>
      </div>
      
      <div class="calc-section">
        <h3>Transformer Ratio Calculation</h3>
        <div class="input-group">
          <label for="tapVoltage">Tap Voltage</label>
          <input type="number" id="tapVoltage" value="">
        </div>
        <div class="input-group">
          <label for="primaryVoltage">Primary Voltage</label>
          <input type="number" id="primaryVoltage" value="">
        </div>
      
        <button class="btn" onclick="calculateTransformerRatioInline()">Calculate Transformer Ratio</button>
        <div class="results" id="transformerResults">
          <p>Transformer Ratio: <span id="transformerRatio">--</span></p>
        </div>
      </div>
      
      <div class="navigation-buttons">
        <button class="nav-btn" onclick="showPage('commissioningPage')">Back</button>
        <button class="nav-btn" onclick="showPage('mainPage')">Main Menu</button>
      </div>
    </div>
  </div>
  
  <!-- SetPoints Page -->
  <div id="setPointsPage" class="content">
    <div class="container">
      <h2>SetPoints</h2>
      <table>
        <tr><th colspan="2">Running Readings</th></tr>
        <tr><td>Frequency</td><td><input type="number" id="frequency-running" value=""></td></tr>
        <tr><td>Amps</td><td><input type="number" id="amps-running" value=""></td></tr>
        <tr><td>Pi</td><td><input type="number" id="pi" value=""></td></tr>
        <tr><td>Pd</td><td><input type="number" id="pd" value=""></td></tr>
        <tr><td>Ti</td><td><input type="number" id="ti" value=""></td></tr>
        <tr><td>Tm</td><td><input type="number" id="tm" value=""></td></tr>
        <tr><td>WHP</td><td><input type="number" id="whp" value=""></td></tr>
        <tr><td>FLP</td><td><input type="number" id="flp" value=""></td></tr>
      </table>
      <button class="btn" onclick="calculateSetpoints()">Calculate Setpoints</button>
      <div class="results" id="setpointsResults">
        <p>OL: <span id="ol-value">--</span></p>
        <p>UL: <span id="ul-value">--</span></p>
        <p>Pd: <span id="pd-value-result">--</span></p>
        <p>Ti: <span id="ti-value">--</span></p>
        <p>Tm: <span id="tm-value">--</span></p>
        <p>WHP: <span id="whp-value">--</span></p>
        <p>FLP: <span id="flp-value">--</span></p>
      </div>
      <div class="navigation-buttons">
        <button class="nav-btn" onclick="showPage('commissioningPage')">Back</button>
        <button class="nav-btn" onclick="showPage('mainPage')">Main Menu</button>
      </div>
    </div>
  </div>
  
  <!-- PGORT Page (Well Listing) -->
  <div id="pgortPage" class="content">
    <div class="container">
      <h2>PGORT</h2>
      <table>
        <tr><th colspan="3">Add Wells Below</th></tr>
      </table>
      <div class="wells-container" id="wellsContainer">
        <button class="btn" onclick="addWell()">+</button>
      </div>
      <div class="navigation-buttons">
        <button class="nav-btn" onclick="showPage('mainPage')">Back</button>
      </div>
    </div>
  </div>
  
  <!-- PGORT Input Page Template (hidden) -->
  <div id="pgortInputPageTemplate" class="content pgortInputPage" style="display: none;">
    <div class="container">
      <h2 class="pgortWellNameHeader">Well: </h2>
      <table>
        <tr>
          <td>Frequency</td>
          <td><input type="number" class="pgortFrequency" value=""></td>
        </tr>
        <tr>
          <td>Total Surface Rate</td>
          <td><input type="number" class="pgortSurfaceRate" value=""></td>
        </tr>
        <tr>
          <td>FvF</td>
          <td><input type="number" class="pgortFvf" value=""></td>
        </tr>
        <tr>
          <td>W/C%</td>
          <td><input type="number" class="pgortWc" value=""></td>
        </tr>
        <tr>
          <td>Range @ 50Hz</td>
          <td>
            <input type="number" class="pgortRangeMin" placeholder="Min">
            <input type="number" class="pgortRangeMax" placeholder="Max">
          </td>
        </tr>
        <tr>
          <td>Motor NP Amps</td>
          <td><input type="number" class="pgortMotorNPAmps" value=""></td>
        </tr>
        <tr>
          <td>Running Amps</td>
          <td><input type="number" class="pgortRunningAmps" value=""></td>
        </tr>
      </table>
      <div class="navigation-buttons">
        <button class="nav-btn" onclick="calculatePgort()">Calculate</button>
        <button class="nav-btn" onclick="showPage('pgortPage')">Back</button>
      </div>
      <!-- Results Section -->
      <div class="results pgortResults" style="display: none;">
        <p>Range @ <span class="pgortOutputFrequency"></span> Hz: <span class="pgortRangeDesiredHz"></span></p>
        <p>Downhole Rate: <span class="pgortDownholeRate"></span></p>
        <p>Status: <span class="pgortStatus"></span></p>
        <p>Motor Load: <span class="pgortMotorLoad"></span></p>
        <button class="nav-btn" onclick="sharePgort()">Share</button>
      </div>
    </div>
  </div>
  
  <!-- Trend Analysis Page -->
  <div id="trendPage" class="content">
    <div class="container">
      <div class="header">
        <h1>ðŸ“ˆ Data Visualization Dashboard</h1>
        <div class="upload-section">
          <!-- File input, file type dropdown, transformer ratio input, and TR refresh button -->
          <div class="file-select-container">
            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" />
            <select id="dataTypeSelect">
              <option value="scada">Scada</option>
              <option value="zenith">Zenith Sensor</option>
              <option value="bhvsd">BH VSD</option>
              <option value="slbvsd">SLB VSD</option>
            </select>
            <input type="number" id="transformerRatioInput" placeholder="Transformer Ratio" />
            <button id="trRefreshButton" onclick="refreshTransformerData()">Refresh TR</button>
          </div>
          <textarea id="excelData" placeholder="Paste your data here or upload a file..."></textarea>
          <button onclick="generateChart()">Generate Chart</button>
          <button onclick="clearData()">Clear Data</button>
        </div>
      </div>
      <div id="checkboxContainer"></div>
      <div class="controls">
        <div class="slider-container">
          <div class="slider-group">
            <label>Start Range: <span id="startValue"></span></label>
            <input type="range" id="startSlider" min="0" value="0" oninput="updateChart()" />
          </div>
          <div class="slider-group">
            <label>End Range: <span id="endValue"></span></label>
            <input type="range" id="endSlider" min="0" value="0" oninput="updateChart()" />
          </div>
        </div>
      </div>
      <div class="chart-container">
        <svg class="tail-svg"></svg>
        <div id="loadingSpinner"></div>
        <canvas id="trendChart"></canvas>
      </div>
      <!-- Export & Navigation Buttons -->
      <div class="export-buttons">
        <button onclick="exportChartAsImage()">ðŸ“¸ Export as Image</button>
        <button onclick="exportChartAsPDF()">ðŸ“„ Export as PDF</button>
        <button onclick="shareChart()">ðŸ”— Share</button>
        <button class="nav-btn" onclick="showPage('mainPage')">Main Menu</button>
      </div>
    </div>
  </div>
  
  <footer>
    <p>Prepared by Eng. Anas amer Aboqayas.</p>
  </footer>
  
  <!-- ESP Solutions JavaScript -->
  <script>
    // Global variables to store raw data for BH VSD refresh
    let lastRawData = null;
    let lastFileFormat = null; // "csv" or "excel"
    let lastDataType = null;
  
    function showPage(pageId) {
      const pages = document.querySelectorAll('.content');
      pages.forEach(page => {
        page.classList.remove('active');
        page.style.display = 'none';
      });
      const target = document.getElementById(pageId);
      if (target) {
        target.classList.add('active');
        target.style.display = 'block';
      }
    }
  
    function interpolate(x, x1, y1, x2, y2) {
      return y1 + ((x - x1) * (y2 - y1)) / (x2 - x1);
    }
  
    // (getYValue and getCorrectionFactor remain unchanged)
    function getYValue(cableSize, amps) {
      const cableSizeTables = {
        1: [[0, 0], [1, 0.226667], [2, 0.453333], [3, 0.68], [4, 0.906667],
            [5, 1.133333], [6, 1.36], [7, 1.586667], [8, 1.813333], [9, 2.04],
            [10, 2.266667], [11, 2.493333], [12, 2.72], [13, 2.946667], [14, 3.173333],
            [15, 3.4], [16, 3.626667], [17, 3.853333], [18, 4.08], [19, 4.306667],
            [20, 4.533333], [21, 4.76], [22, 4.986667], [23, 5.213333], [24, 5.44],
            [25, 5.666667], [26, 5.893333], [27, 6.12], [28, 6.346667], [29, 6.573333],
            [30, 6.8], [31, 7.026667], [32, 7.253333], [33, 7.48], [34, 7.706667],
            [35, 7.933333], [36, 8.16], [37, 8.386667], [38, 8.613333], [39, 8.84],
            [40, 9.066667], [41, 9.293333], [42, 9.52], [43, 9.746667], [44, 9.973333],
            [45, 10.2], [46, 10.426667], [47, 10.653333], [48, 10.88], [49, 11.106667],
            [50, 11.333333], [51, 11.56], [52, 11.786667], [53, 12.013333], [54, 12.24],
            [55, 12.466667], [56, 12.693333], [57, 12.92], [58, 13.146667], [59, 13.373333],
            [60, 13.6], [61, 13.826667], [62, 14.053333], [63, 14.28], [64, 14.506667],
            [65, 14.733333], [66, 14.96], [67, 15.186667], [68, 15.413333], [69, 15.64],
            [70, 15.866667], [71, 16.093333], [72, 16.32], [73, 16.546667], [74, 16.773333],
            [75, 17.0], [76, 17.226667], [77, 17.453333], [78, 17.68], [79, 17.906667],
            [80, 18.133333], [81, 18.36], [82, 18.586667], [83, 18.813333], [84, 19.04],
            [85, 19.266667], [86, 19.493333]]
      };
      const table = cableSizeTables[cableSize];
      for (let i = 0; i < table.length - 1; i++) {
        const [x1, y1] = table[i];
        const [x2, y2] = table[i + 1];
        if (amps >= x1 && amps <= x2) {
          return interpolate(amps, x1, y1, x2, y2);
        }
      }
      return null;
    }
  
    function getCorrectionFactor(bht) {
      const tempTable = [
        [100, 1.07], [110, 1.092], [120, 1.114], [131, 1.12], [149, 1.15],
        [167, 1.19], [185, 1.23], [203, 1.27], [221, 1.31], [239, 1.35],
        [257, 1.39], [275, 1.42], [293, 1.46], [302, 1.48]
      ];
      for (let i = 0; i < tempTable.length - 1; i++) {
        const [T1, CF1] = tempTable[i];
        const [T2, CF2] = tempTable[i + 1];
        if (bht >= T1 && bht <= T2) {
          return interpolate(bht, T1, CF1, T2, CF2);
        }
      }
      return null;
    }
  
    function calculateVoltageInline() {
      const desiredFrequency = parseFloat(document.getElementById('desiredFrequency').value);
      const voltage = parseFloat(document.getElementById('voltage').value);
      const amps = parseFloat(document.getElementById('amps').value);
      const cableLength = parseFloat(document.getElementById('cableLength').value);
      const cableSize = parseFloat(document.getElementById('cableSize').value);
      const bht = parseFloat(document.getElementById('bht').value);
  
      const yValue = getYValue(cableSize, amps);
      const correctionFactor = getCorrectionFactor(bht);
  
      const voltageDrop = yValue * (cableLength / 1000) * correctionFactor;
      const voltage50Hz = voltageDrop + voltage;
      const voltageDesiredHz = (voltage * (desiredFrequency / 50)) + voltageDrop;
  
      document.getElementById('voltage50Hz').innerText = voltage50Hz.toFixed(2);
      document.getElementById('voltageDesiredHz').innerText = voltageDesiredHz.toFixed(2);
      document.getElementById('desiredFrequencyLabel').innerText = desiredFrequency;
    }
  
    function calculateTransformerRatioInline() {
      const manufacturer = document.getElementById('manufacturer-installation').value;
      const tapVoltage = parseFloat(document.getElementById('tapVoltage').value);
      const primaryVoltage = parseFloat(document.getElementById('primaryVoltage').value);
      let ratio;
      if (manufacturer === "SLB") {
        ratio = primaryVoltage / tapVoltage;
      } else {
        ratio = tapVoltage / primaryVoltage;
      }
      document.getElementById('transformerRatio').innerText = ratio.toFixed(2);
    }
  
    function calculateSetpoints() {
      const ampsMotor = parseFloat(document.getElementById('amps').value);
      const ampsRunning = parseFloat(document.getElementById('amps-running').value);
      const pdRunning = parseFloat(document.getElementById('pd').value);
      const tiRunning = parseFloat(document.getElementById('ti').value);
      const tmRunning = parseFloat(document.getElementById('tm').value);
      const whpRunning = parseFloat(document.getElementById('whp').value);
      const flpRunning = parseFloat(document.getElementById('flp').value);
      const olValue = ampsMotor * 1.1;
      const ulValue = ampsRunning * 0.8;
      const pdValue = Math.min(500 + pdRunning, 4500);
      const tiValue = 30 + tiRunning;
      const tmValue = 30 + tmRunning;
      const whpValue = Math.min(400 + whpRunning, 1200);
      const flpValue = Math.min(350 + flpRunning, 800);
      document.getElementById('ol-value').innerText = olValue.toFixed(2);
      document.getElementById('ul-value').innerText = ulValue.toFixed(2);
      document.getElementById('pd-value-result').innerText = pdValue.toFixed(2);
      document.getElementById('ti-value').innerText = tiValue.toFixed(2);
      document.getElementById('tm-value').innerText = tmValue.toFixed(2);
      document.getElementById('whp-value').innerText = whpValue.toFixed(2);
      document.getElementById('flp-value').innerText = flpValue.toFixed(2);
    }
  
    // PGORT Functions
    function addWell() {
      const wellsContainer = document.getElementById('wellsContainer');
      const wellCount = wellsContainer.querySelectorAll('.well-entry').length;
      const wellEntry = document.createElement('div');
      wellEntry.classList.add('well-entry');
      const wellId = `well-${wellCount}`;
      wellEntry.setAttribute("data-well-id", wellId);
  
      wellEntry.innerHTML = `
        <input type="text" placeholder="Well name">
        <button class="nav-btn" onclick="goToPgortInput('${wellId}')">Select</button>
        <button class="nav-btn" onclick="deleteWell(this)">&#128465;</button>
      `;
      wellsContainer.appendChild(wellEntry);
    }
  
    function goToPgortInput(wellId) {
      const wellEntry = document.querySelector(`[data-well-id="${wellId}"]`);
      const wellName = wellEntry.querySelector('input[type="text"]').value || wellId;
      let page = document.getElementById("pgortInputPage-" + wellId);
      if (!page) {
        const template = document.getElementById("pgortInputPageTemplate");
        page = template.cloneNode(true);
        page.id = "pgortInputPage-" + wellId;
        page.style.display = "none";
        page.querySelector(".pgortWellNameHeader").innerText = "Well: " + wellName;
        document.body.appendChild(page);
      }
      showPage(page.id);
    }
  
    function calculatePgort() {
      const page = document.querySelector(".content.active");
      if (!page || !page.id.startsWith("pgortInputPage-")) return;
      const frequency = parseFloat(page.querySelector(".pgortFrequency").value);
      const surfaceRate = parseFloat(page.querySelector(".pgortSurfaceRate").value);
      const fvf = parseFloat(page.querySelector(".pgortFvf").value);
      const wc = parseFloat(page.querySelector(".pgortWc").value);
      const rangeMin50Hz = parseFloat(page.querySelector(".pgortRangeMin").value);
      const rangeMax50Hz = parseFloat(page.querySelector(".pgortRangeMax").value);
      const motorNPAmps = parseFloat(page.querySelector(".pgortMotorNPAmps").value);
      const runningAmps = parseFloat(page.querySelector(".pgortRunningAmps").value);
  
      const rangeMinDesiredHz = (frequency / 50) * rangeMin50Hz;
      const rangeMaxDesiredHz = (frequency / 50) * rangeMax50Hz;
      const downholeRate = ((surfaceRate * (1 - (wc / 100))) * fvf) + (surfaceRate * (wc / 100));
      let status;
      if (downholeRate >= rangeMinDesiredHz && downholeRate <= rangeMaxDesiredHz) {
        status = "In range";
      } else if (downholeRate < rangeMinDesiredHz) {
        status = "Down thrust";
      } else {
        status = "Up thrust";
      }
      const motorLoad = (runningAmps / motorNPAmps) * 100;
  
      page.querySelector(".pgortOutputFrequency").innerText = frequency;
      page.querySelector(".pgortRangeDesiredHz").innerText = `${rangeMinDesiredHz.toFixed(0)} - ${rangeMaxDesiredHz.toFixed(0)}`;
      page.querySelector(".pgortDownholeRate").innerText = downholeRate.toFixed(0);
      page.querySelector(".pgortStatus").innerText = status;
      page.querySelector(".pgortMotorLoad").innerText = motorLoad.toFixed(2) + '%';
  
      page.querySelector(".pgortResults").style.display = "block";
    }
  
    function sharePgort() {
      const page = document.querySelector(".content.active");
      if (!page || !page.id.startsWith("pgortInputPage-")) return;
      const frequency = page.querySelector(".pgortOutputFrequency").innerText;
      const rangeDesiredHz = page.querySelector(".pgortRangeDesiredHz").innerText;
      const downholeRate = page.querySelector(".pgortDownholeRate").innerText;
      const status = page.querySelector(".pgortStatus").innerText;
      const motorLoad = page.querySelector(".pgortMotorLoad").innerText;
      const wellName = page.querySelector(".pgortWellNameHeader").innerText;
  
      const shareMessage = `${wellName}
Range @ ${frequency} Hz: ${rangeDesiredHz}
Downhole Rate: ${downholeRate}
Status: ${status}
Motor Load: ${motorLoad}`;
  
      if (navigator.share) {
        navigator.share({
          title: wellName + " Results",
          text: shareMessage
        })
        .then(() => console.log('Share successful'))
        .catch(error => console.error('Error sharing:', error));
      } else {
        alert("Sharing is not supported on this browser. Results:\n" + shareMessage);
      }
    }
  
    function deleteWell(button) {
      const wellEntry = button.closest('.well-entry');
      wellEntry.remove();
    }
  
    // Trend App Functions
    document.addEventListener("DOMContentLoaded", function () {
      let chart;
      let allLabels = [];
      let allDatasets = [];
      let activeDatasets = [];
      const colorPalette = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
  
      const chartContainer = document.querySelector('#trendPage .chart-container');
      const tailSVG = document.querySelector('#trendPage .tail-svg');
  
      // --- Data processing functions ---
  
      // SCADA processing
      function processScadaCSVData(csvData) {
        const rows = csvData.split(/\r?\n/).filter(row => row.trim() !== "")
          .map(row => row.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/)
          .map(cell => cell.replace(/^"|"$/g, "").trim()));
        if (rows.length < 1) {
          alert("Invalid CSV file format.");
          return;
        }
        const scadaColumns = [0, 19, 20, 21, 22, 3, 5, 10, 15];
        const scadaHeaders = ["Date/Time", "Pi", "Pd", "Ti", "Tm", "WHP", "FLP", "Amps", "Freq"];
        const processedRows = rows.map((row, rowIndex) => {
          let newRow = [];
          scadaColumns.forEach(colIndex => {
            newRow.push(row[colIndex] !== undefined ? row[colIndex] : "");
          });
          if (rowIndex === 0) {
            newRow = scadaHeaders;
          }
          return newRow;
        });
        const processedData = processedRows.map(row => row.join('\t')).join('\n');
        document.getElementById('excelData').value = processedData;
        generateChart();
      }
  
      function processScadaExcelData(workbook) {
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        let jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false });
        if (jsonData.length < 1) {
          alert("Invalid Excel file.");
          return;
        }
        const scadaColumns = [0, 19, 20, 21, 22, 3, 5, 10, 15];
        const scadaHeaders = ["Date/Time", "Pi", "Pd", "Ti", "Tm", "WHP", "FLP", "Amps", "Freq"];
        const processedRows = jsonData.map((row, rowIndex) => {
          let newRow = [];
          scadaColumns.forEach(colIndex => {
            newRow.push(row[colIndex] !== undefined ? row[colIndex] : "");
          });
          if (rowIndex === 0) {
            newRow = scadaHeaders;
          }
          return newRow;
        });
        const processedData = processedRows.map(row => row.join('\t')).join('\n');
        document.getElementById('excelData').value = processedData;
        generateChart();
      }
  
      // Zenith processing: take header from row2 (index 1) and data from row4 (index 3) downward (skip row3)
      function processZenithCSVData(csvData) {
        const rows = csvData.split(/\r?\n/)
          .filter(row => row.trim() !== "")
          .map(row => row.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/)
          .map(cell => cell.replace(/^"|"$/g, "").trim()));
        if (rows.length < 4) {
          alert("Not enough rows for Zenith sensor data.");
          return;
        }
        // Use headers from row 2 (index 1) and data from row 4 (index 3) downward, skipping row 3 (index 2)
        const header = rows[1].slice(0, 9);
        const dataRows = rows.slice(3).map(row => row.slice(0, 9));
        const processedData = [header, ...dataRows].map(row => row.join('\t')).join('\n');
        document.getElementById('excelData').value = processedData;
        generateChart();
      }
  
      function processZenithExcelData(workbook) {
        let jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
        if (jsonData.length < 4) {
          alert("Not enough rows for Zenith sensor data.");
          return;
        }
        // Use row2 (index 1) as header and data from row4 (index 3) downward, skipping row3 (index 2)
        const header = jsonData[1].slice(0, 9);
        const dataRows = jsonData.slice(3).map(row => row.slice(0, 9));
        const processedData = [header, ...dataRows].map(row => row.join('\t')).join('\n');
        document.getElementById('excelData').value = processedData;
        generateChart();
      }
  
      // BH VSD processing: generate a twoâ€‘column dataset using the first column and
      // an "Amps" column calculated as the average of columns B and C (from row 2 downward)
      function processBHVSDCSVData(csvData) {
        const rows = csvData.split(/\r?\n/)
          .filter(row => row.trim() !== "")
          .map(row => row.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/)
          .map(cell => cell.replace(/^"|"$/g, "").trim()));
        if (rows.length < 2) {
          alert("Not enough rows for BH VSD data.");
          return;
        }
        const newHeader = [rows[0][0], "Amps"];
        const transformerRatio = parseFloat(document.getElementById('transformerRatioInput').value) || 1;
        const newDataRows = rows.slice(1).map(row => {
          const date = row[0];
          const b = parseFloat(row[1]) || 0;
          const c = parseFloat(row[2]) || 0;
          const avg = (b + c) / 2;
          const calcValue = avg / transformerRatio;
          // Round the amps value to an integer with no decimals
          return [date, Math.round(calcValue)];
        });
        const processedData = [newHeader, ...newDataRows].map(row => row.join('\t')).join('\n');
        document.getElementById('excelData').value = processedData;
        generateChart();
      }
  
      function processBHVSDExcelData(workbook) {
        let jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1, raw: false });
        if (jsonData.length < 2) {
          alert("Not enough rows for BH VSD data.");
          return;
        }
        const newHeader = [jsonData[0][0], "Amps"];
        const transformerRatio = parseFloat(document.getElementById('transformerRatioInput').value) || 1;
        const newDataRows = jsonData.slice(1).map(row => {
          const date = row[0];
          const b = parseFloat(row[1]) || 0;
          const c = parseFloat(row[2]) || 0;
          const avg = (b + c) / 2;
          const calcValue = avg / transformerRatio;
          // Round to the nearest integer
          return [date, Math.round(calcValue)];
        });
        const processedData = [newHeader, ...newDataRows].map(row => row.join('\t')).join('\n');
        document.getElementById('excelData').value = processedData;
        generateChart();
      }
  
      // Fallback CSV processing
      function processCSVData(csvData) {
        const rows = csvData.split(/\r?\n/).filter(row => row.trim() !== "")
                      .map(row => row.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/)
                      .map(cell => cell.replace(/^"|"$/g, "").trim()));
        if (rows.length < 2) {
          alert("Invalid CSV file format.");
          return;
        }
        const processedRows = rows.map(row => row.join('\t'));
        const processedData = processedRows.join('\n');
        document.getElementById('excelData').value = processedData;
        generateChart();
      }
  
      // File input change event
      document.getElementById('fileInput').addEventListener('change', function (event) {
        const file = event.target.files[0];
        if (!file) return;
        const dataType = document.getElementById('dataTypeSelect').value.toLowerCase();
        lastDataType = dataType;  // store for refresh if needed
        const reader = new FileReader();
  
        if (file.name.endsWith('.csv')) {
          reader.onload = function (e) {
            const csvData = e.target.result;
            // If BH VSD, store raw CSV data for refresh
            if (dataType === "bhvsd") {
              lastRawData = csvData;
              lastFileFormat = "csv";
            }
            if (dataType === "scada") {
              processScadaCSVData(csvData);
            } else if (dataType === "zenith") {
              processZenithCSVData(csvData);
            } else if (dataType === "bhvsd") {
              processBHVSDCSVData(csvData);
            } else {
              processCSVData(csvData);
            }
          };
          reader.readAsText(file);
        } else {
          reader.onload = function (e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            // If BH VSD, store workbook for refresh
            if (dataType === "bhvsd") {
              lastRawData = workbook;
              lastFileFormat = "excel";
            }
            if (dataType === "scada") {
              processScadaExcelData(workbook);
            } else if (dataType === "zenith") {
              processZenithExcelData(workbook);
            } else if (dataType === "bhvsd") {
              processBHVSDExcelData(workbook);
            } else {
              let jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
              if (jsonData.length === 0) {
                alert("Invalid Excel file. Please upload a valid Excel sheet.");
                return;
              }
              let startIndex = -1;
              for (let i = 0; i < jsonData.length; i++) {
                if (!isNaN(jsonData[i][0]) && jsonData[i][1] !== undefined) {
                  startIndex = i - 1;
                  break;
                }
              }
              if (startIndex < 0) {
                alert("No valid date/time found in the first column.");
                return;
              }
              jsonData = jsonData.slice(startIndex);
              jsonData.forEach((row, index) => {
                if (index > 0 && !isNaN(row[0])) {
                  row[0] = excelDateToJSDate(row[0]);
                }
              });
              document.getElementById('excelData').value = jsonData.map(row => row.join('\t')).join('\n');
              generateChart();
            }
          };
          reader.readAsArrayBuffer(file);
        }
      });
  
      // Show or hide Transformer Ratio input and refresh button based on selected data type
      document.getElementById('dataTypeSelect').addEventListener('change', function() {
        const transformerInput = document.getElementById('transformerRatioInput');
        const refreshButton = document.getElementById('trRefreshButton');
        if (this.value.toLowerCase() === 'bhvsd') {
          transformerInput.style.display = 'block';
          refreshButton.style.display = 'block';
        } else {
          transformerInput.style.display = 'none';
          refreshButton.style.display = 'none';
        }
      });
  
      // Function to refresh BH VSD data when TR value is changed
      window.refreshTransformerData = function () {
        if (lastDataType === "bhvsd" && lastRawData) {
          if (lastFileFormat === "csv") {
            processBHVSDCSVData(lastRawData);
          } else if (lastFileFormat === "excel") {
            processBHVSDExcelData(lastRawData);
          }
        } else {
          alert("No BH VSD file data available to refresh.");
        }
      };
  
      // Chart generation and updateChart function (using fixed pairing logic)
      window.generateChart = function () {
        document.getElementById('loadingSpinner').style.display = 'block';
        const excelData = document.getElementById('excelData').value.trim();
        if (!excelData) {
          alert('Please paste or upload data.');
          return;
        }
        const rows = excelData.split('\n').map(row => row.split('\t'));
        if (rows.length < 2 || rows[0].length < 2) {
          alert('Invalid data format.');
          return;
        }
        allLabels = rows.slice(1).map(row => row[0] || 'N/A');
        allDatasets = [];
        activeDatasets = [];
      
        const checkboxContainer = document.getElementById('checkboxContainer');
        checkboxContainer.innerHTML = '';
        checkboxContainer.style.display = 'flex';
        for (let i = 1; i < rows[0].length; i++) {
          const data = rows.slice(1).map(row => parseFloat((row[i] || "").replace(/,/g, "")) || null);
          const dataset = {
            label: rows[0][i] || `Dataset ${i}`,
            data: data,
            borderColor: colorPalette[i % colorPalette.length],
            backgroundColor: colorPalette[i % colorPalette.length],
            borderWidth: 2,
            fill: false,
            pointRadius: 0,
            pointBackgroundColor: colorPalette[i % colorPalette.length]
          };
          // Fixed pair grouping: every two datasets share a pairIndex
          dataset.pairIndex = Math.floor((i - 1) / 2);
          allDatasets.push(dataset);
          activeDatasets.push(dataset);
      
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = true;
          checkbox.onchange = () => {
            if (checkbox.checked) {
              activeDatasets.push(dataset);
            } else {
              activeDatasets = activeDatasets.filter(ds => ds.label !== dataset.label);
            }
            updateChart();
          };
      
          const labelElem = document.createElement('label');
          labelElem.appendChild(checkbox);
          labelElem.appendChild(document.createTextNode(` ${dataset.label}`));
          checkboxContainer.appendChild(labelElem);
        }
      
        const startSlider = document.getElementById('startSlider');
        const endSlider = document.getElementById('endSlider');
        startSlider.max = allLabels.length - 1;
        endSlider.max = allLabels.length - 1;
        endSlider.value = allLabels.length - 1;
      
        updateChart();
        document.getElementById('loadingSpinner').style.display = 'none';
      };
  
      window.updateChart = function () {
        const startIndex = parseInt(document.getElementById('startSlider').value, 10);
        const endIndex = parseInt(document.getElementById('endSlider').value, 10);
        document.getElementById('startValue').textContent = allLabels[startIndex];
        document.getElementById('endValue').textContent = allLabels[endIndex];
    
        const filteredLabels = allLabels.slice(startIndex, endIndex + 1);
        const filteredDatasets = activeDatasets.map(dataset => ({
          ...dataset,
          data: dataset.data.slice(startIndex, endIndex + 1)
        }));
    
        if (chart) chart.destroy();
        const ctx = document.getElementById('trendChart').getContext('2d');
    
        // Group datasets by their fixed pairIndex
        const groups = {};
        filteredDatasets.forEach(ds => {
          if (ds.pairIndex !== undefined) {
            if (!groups[ds.pairIndex]) groups[ds.pairIndex] = [];
            groups[ds.pairIndex].push(ds);
          }
        });
    
        const scales = {
          x: {
            title: { display: true, text: 'Date/Time', color: '#000000' },
            grid: { color: 'rgba(0, 0, 0, 0.1)' }
          }
        };
    
        Object.keys(groups).forEach(key => {
          const group = groups[key];
          const yAxisID = `y${parseInt(key, 10) + 1}`;
          let combinedData = [];
          group.forEach(ds => {
            combinedData = combinedData.concat(ds.data.filter(d => d !== null && !isNaN(d)));
          });
          const minDataValue = Math.min(...combinedData);
          const maxDataValue = Math.max(...combinedData);
          const roundUp = (value) => {
            const power = Math.pow(10, Math.floor(Math.log10(value)));
            return Math.ceil(value / power) * power;
          };
          const roundDown = (value) => {
            const power = Math.pow(10, Math.floor(Math.log10(value)));
            return Math.floor(value / power) * power;
          };
          const rangePadding = (maxDataValue - minDataValue) * 0.05;
          const roundedMin = roundDown(minDataValue - rangePadding);
          const roundedMax = roundUp(maxDataValue + rangePadding);
          const pos = (parseInt(key, 10) % 2 === 0) ? 'left' : 'right';
    
          scales[yAxisID] = {
            type: 'linear',
            display: true,
            position: pos,
            title: { display: true, text: group.map(ds => ds.label).join(' | '), color: '#000000' },
            grid: { color: 'rgba(0, 0, 0, 0.1)' },
            min: roundedMin,
            max: roundedMax
          };
    
          group.forEach(ds => {
            ds.yAxisID = yAxisID;
          });
        });
    
        chart = new Chart(ctx, {
          type: 'line',
          data: { labels: filteredLabels, datasets: filteredDatasets },
          options: {
            responsive: true,
            scales: scales,
            plugins: {
              legend: {
                display: true,
                labels: {
                  color: '#000000',
                  usePointStyle: true,
                  pointStyle: 'circle'
                }
              }
            },
            onClick: (event) => handleChartClick(event),
            backgroundColor: '#ffffff'
          }
        });
      };
  
      function handleChartClick(event) {
        const points = chart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
        if (!points.length) return;
        const point = points[0];
        const x = point.element.x;
        const y = point.element.y;
        const canvas = document.getElementById('trendChart');
        const canvasRect = canvas.getBoundingClientRect();
        const containerRect = chartContainer.getBoundingClientRect();
        const offsetX = canvasRect.left - containerRect.left;
        const offsetY = canvasRect.top - containerRect.top;
        const clickedX = offsetX + x;
        const clickedY = offsetY + y;
        const xValue = chart.data.labels[point.index];
        const yValue = point.element.$context.raw;
        const dataset = chart.data.datasets[point.datasetIndex];
        const defaultText = `<span style="color:#000; font-weight:bold;">Date/Time:</span> <span style="color:#000;">${xValue}</span><br/><span style="color:#000; font-weight:bold;">${dataset.label}:</span> <span style="color:#000;">${yValue}</span>`;
        createCalloutBubble(clickedX, clickedY, defaultText, point.datasetIndex, point.index);
      }
  
      window.exportChartAsImage = function () {
        html2canvas(document.querySelector('#trendPage .chart-container'), { backgroundColor: "#ffffff" }).then(function(canvas) {
          const link = document.createElement('a');
          link.href = canvas.toDataURL("image/png");
          link.download = 'chart_with_callouts.png';
          link.click();
        });
      };
  
      window.exportChartAsPDF = function () {
        html2canvas(document.querySelector('#trendPage .chart-container'), { backgroundColor: "#ffffff" }).then(function(canvas) {
          const imgData = canvas.toDataURL("image/png");
          const pdf = new jspdf.jsPDF();
          pdf.addImage(imgData, 'PNG', 10, 10, 180, 100);
          pdf.save('chart_with_callouts.pdf');
        });
      };
  
      window.shareChart = async function () {
        try {
          const container = document.querySelector('#trendPage .chart-container');
          const canvas = await html2canvas(container, { backgroundColor: "#ffffff" });
          canvas.toBlob(async (blob) => {
            const file = new File([blob], "chart.png", { type: "image/png" });
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
              await navigator.share({
                title: "Trend Chart",
                text: "Check out this trend chart from ESP Solutions!",
                files: [file]
              });
            } else {
              alert("Sharing files is not supported on this browser. Here's the chart image as data URL:\n" + canvas.toDataURL());
            }
          }, "image/png");
        } catch (error) {
          console.error("Error capturing chart:", error);
          alert("Failed to share chart image.");
        }
      };
  
      window.clearData = function () {
        document.getElementById('loadingSpinner').style.display = 'none';
        document.getElementById('fileInput').value = "";
        document.getElementById('excelData').value = "";
        const checkboxContainer = document.getElementById('checkboxContainer');
        checkboxContainer.innerHTML = "";
        checkboxContainer.style.display = "none";
        const startSlider = document.getElementById('startSlider');
        const endSlider = document.getElementById('endSlider');
        startSlider.value = 0;
        endSlider.value = 0;
        startSlider.max = 0;
        endSlider.max = 0;
        document.getElementById('startValue').textContent = "";
        document.getElementById('endValue').textContent = "";
        allLabels = [];
        allDatasets = [];
        activeDatasets = [];
        if (chart) {
          chart.destroy();
          chart = null;
        }
        const canvas = document.getElementById('trendChart');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        canvas.width = canvas.width;
      };
  
      function createCalloutBubble(clickedX, clickedY, content, datasetIndex, pointIndex) {
        const bubbleWidth = 150;
        const bubbleHeight = 100;
        const bubbleLeft = clickedX - bubbleWidth / 2;
        const bubbleTop = clickedY - bubbleHeight - 10;
  
        const bubble = document.createElement('div');
        bubble.classList.add('callout');
        bubble.style.backgroundColor = "#ffffff";
        bubble.style.width = bubbleWidth + 'px';
        bubble.style.height = bubbleHeight + 'px';
        bubble.style.left = bubbleLeft + 'px';
        bubble.style.top = bubbleTop + 'px';
  
        const dragHandle = document.createElement('div');
        dragHandle.classList.add('callout-drag-handle');
        bubble.appendChild(dragHandle);
  
        const deleteBtn = document.createElement('button');
        deleteBtn.classList.add('callout-delete');
        deleteBtn.innerText = 'Ã—';
        bubble.appendChild(deleteBtn);
  
        const contentArea = document.createElement('div');
        contentArea.classList.add('callout-content');
        contentArea.style.backgroundColor = "#ffffff";
        contentArea.contentEditable = true;
        contentArea.innerHTML = content;
        contentArea.style.fontSize = "12px";
        bubble.appendChild(contentArea);
  
        const resizeHandle = document.createElement('div');
        resizeHandle.classList.add('callout-resize-handle');
        bubble.appendChild(resizeHandle);
  
        chartContainer.appendChild(bubble);
  
        const poly = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
        poly.setAttribute("fill", "#ffffff");
        poly.setAttribute("stroke", "#666");
        poly.setAttribute("stroke-width", "1");
        tailSVG.appendChild(poly);
        bubble.tailPoly = poly;
  
        bubble.clickedX = clickedX;
        bubble.clickedY = clickedY;
        bubble.datasetIndex = datasetIndex;
        bubble.pointIndex = pointIndex;
        updateTail(bubble);
  
        deleteBtn.addEventListener('click', function (e) {
          chartContainer.removeChild(bubble);
          tailSVG.removeChild(bubble.tailPoly);
          e.stopPropagation();
        });
  
        makeElementDraggable(bubble, dragHandle);
        makeElementResizable(bubble, resizeHandle);
      }
  
      function updateTail(bubble) {
        if (!bubble.tailPoly) return;
        const containerRect = chartContainer.getBoundingClientRect();
        const bubbleRect = bubble.getBoundingClientRect();
        const baseWidth = 20;
        const baseCenterX = bubbleRect.left + bubbleRect.width / 2;
        const baseCenterY = bubbleRect.bottom;
        const baseLeftX = baseCenterX - baseWidth / 2;
        const baseLeftY = baseCenterY;
        const baseRightX = baseCenterX + baseWidth / 2;
        const baseRightY = baseCenterY;
        const tipX = bubble.clickedX;
        const tipY = bubble.clickedY;
        const p1 = `${baseLeftX - containerRect.left},${baseLeftY - containerRect.top}`;
        const p2 = `${baseRightX - containerRect.left},${baseRightY - containerRect.top}`;
        const p3 = `${tipX},${tipY}`;
        const points = `${p1} ${p2} ${p3}`;
        bubble.tailPoly.setAttribute('points', points);
      }
  
      function excelDateToJSDate(serial) {
        const excelEpoch = new Date(1899, 11, 30);
        const daysOffset = serial - 1;
        const date = new Date(excelEpoch.getTime() + daysOffset * 86400000);
        const hours = Math.floor((serial % 1) * 24);
        const minutes = Math.floor(((serial % 1) * 1440) % 60);
        return `${date.getDate().toString().padStart(2, '0')}/` +
               `${(date.getMonth() + 1).toString().padStart(2, '0')}/` +
               `${date.getFullYear()} ` +
               `${hours.toString().padStart(2, '0')}:` +
               `${minutes.toString().padStart(2, '0')}`;
      }
  
      function makeElementDraggable(el, handle) {
        let offsetX, offsetY;
        handle.addEventListener('mousedown', mouseDownHandler);
        document.addEventListener('mousemove', mouseMoveHandler);
        document.addEventListener('mouseup', mouseUpHandler);
        handle.addEventListener('touchstart', touchStartHandler, { passive: false });
        document.addEventListener('touchmove', touchMoveHandler, { passive: false });
        document.addEventListener('touchend', touchEndHandler);
  
        function mouseDownHandler(e) {
          e.preventDefault();
          offsetX = e.clientX - el.getBoundingClientRect().left;
          offsetY = e.clientY - el.getBoundingClientRect().top;
          document.addEventListener('mousemove', mouseMoveHandler);
          document.addEventListener('mouseup', mouseUpHandler);
        }
  
        function mouseMoveHandler(e) {
          e.preventDefault();
          const containerRect = chartContainer.getBoundingClientRect();
          el.style.left = (e.clientX - containerRect.left - offsetX) + 'px';
          el.style.top = (e.clientY - containerRect.top - offsetY) + 'px';
          updateTail(el);
        }
  
        function mouseUpHandler() {
          document.removeEventListener('mousemove', mouseMoveHandler);
          document.removeEventListener('mouseup', mouseUpHandler);
        }
  
        function touchStartHandler(e) {
          e.preventDefault();
          const touch = e.touches[0];
          offsetX = touch.clientX - el.getBoundingClientRect().left;
          offsetY = touch.clientY - el.getBoundingClientRect().top;
          document.addEventListener('touchmove', touchMoveHandler, { passive: false });
          document.addEventListener('touchend', touchEndHandler);
        }
  
        function touchMoveHandler(e) {
          e.preventDefault();
          const touch = e.touches[0];
          const containerRect = chartContainer.getBoundingClientRect();
          el.style.left = (touch.clientX - containerRect.left - offsetX) + 'px';
          el.style.top = (touch.clientY - containerRect.top - offsetY) + 'px';
          updateTail(el);
        }
  
        function touchEndHandler() {
          document.removeEventListener('touchmove', touchMoveHandler);
          document.removeEventListener('touchend', touchEndHandler);
        }
      }
  
      function makeElementResizable(el, handle) {
        let startX, startY, startWidth, startHeight;
        const minFontSize = 5;
        const maxFontSize = 12;
  
        const contentArea = el.querySelector('.callout-content');
        if (contentArea) {
          contentArea.dataset.originalFontSize = maxFontSize;
        }
  
        handle.addEventListener('mousedown', mouseDownHandler);
        document.addEventListener('mousemove', mouseMoveHandler);
        document.addEventListener('mouseup', mouseUpHandler);
        handle.addEventListener('touchstart', touchStartHandler, { passive: false });
        document.addEventListener('touchmove', touchMoveHandler, { passive: false });
        document.addEventListener('touchend', touchEndHandler);
  
        function mouseDownHandler(e) {
          e.stopPropagation();
          startX = e.clientX;
          startY = e.clientY;
          startWidth = parseInt(document.defaultView.getComputedStyle(el).width, 10);
          startHeight = parseInt(document.defaultView.getComputedStyle(el).height, 10);
          document.addEventListener('mousemove', mouseMoveHandler);
          document.addEventListener('mouseup', mouseUpHandler);
        }
  
        function mouseMoveHandler(e) {
          e.preventDefault();
          const newWidth = startWidth + (e.clientX - startX);
          const newHeight = startHeight + (e.clientY - startY);
  
          el.style.width = newWidth + 'px';
          el.style.height = newHeight + 'px';
  
          adjustFontSize(el, newWidth, newHeight);
  
          updateTail(el);
        }
  
        function mouseUpHandler() {
          document.removeEventListener('mousemove', mouseMoveHandler);
          document.removeEventListener('mouseup', mouseUpHandler);
        }
  
        function touchStartHandler(e) {
          e.preventDefault();
          const touch = e.touches[0];
          startX = touch.clientX;
          startY = touch.clientY;
          startWidth = parseInt(document.defaultView.getComputedStyle(el).width, 10);
          startHeight = parseInt(document.defaultView.getComputedStyle(el).height, 10);
          document.addEventListener('touchmove', touchMoveHandler, { passive: false });
          document.addEventListener('touchend', touchEndHandler);
        }
  
        function touchMoveHandler(e) {
          e.preventDefault();
          const touch = e.touches[0];
          const newWidth = startWidth + (touch.clientX - startX);
          const newHeight = startHeight + (touch.clientY - startY);
  
          el.style.width = newWidth + 'px';
          el.style.height = newHeight + 'px';
  
          adjustFontSize(el, newWidth, newHeight);
  
          updateTail(el);
        }
  
        function touchEndHandler() {
          document.removeEventListener('touchmove', touchMoveHandler);
          document.removeEventListener('touchend', touchEndHandler);
        }
  
        function adjustFontSize(el, width, height) {
          const contentArea = el.querySelector('.callout-content');
          if (!contentArea) return;
  
          const originalFontSize = parseFloat(contentArea.dataset.originalFontSize);
          const scaleFactor = Math.min(width / el.offsetWidth, height / el.offsetHeight);
          const newFontSize = Math.max(minFontSize, Math.min(maxFontSize, originalFontSize * scaleFactor));
          contentArea.style.fontSize = newFontSize + 'px';
        }
      }
    });
  </script>
</body>
</html>
